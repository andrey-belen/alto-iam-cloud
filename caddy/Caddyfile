# AICODE-NOTE: Caddy reverse proxy for Alto IAM Cloud
# HTTP only - Cloudflare handles HTTPS termination (Flexible SSL mode)

:80 {
    # Alto CERO IAM Dashboard - default route
    @dashboard {
        not path /realms/* /admin/* /resources/* /js/* /api/*
    }
    reverse_proxy @dashboard alto-cero-iam:80 {
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Port 443
    }

    # Keycloak - auth paths
    @keycloak {
        path /realms/* /admin/* /resources/* /js/*
    }
    reverse_proxy @keycloak keycloak:8080 {
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Port 443
    }

    # API - backend (strip /api prefix before forwarding)
    handle_path /api/* {
        reverse_proxy api:3001 {
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Port 443
        }
    }
}
